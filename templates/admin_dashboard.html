{% extends "base.html" %}
{% block title %}ADMIN - RE Marketplace{% endblock %}

{% block content %}
<div class="container py-4">
  <h1 class="mb-4">Admin Dashboard</h1>

  <!-- KPI cards -->
  <div class="row g-4 mb-4">
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="text-muted text-uppercase">Users</h6>
          <div class="display-6">{{ users_count }}</div>
          <a href="{{ url_for('export_users_csv') }}" class="btn btn-sm btn-outline-secondary mt-2">Export CSV</a>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="text-muted text-uppercase">Projects</h6>
          <div class="display-6">{{ projects_count }}</div>
          <a href="{{ url_for('export_projects_csv') }}" class="btn btn-sm btn-outline-secondary mt-2">Export CSV</a>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="text-muted text-uppercase">Callback Requests</h6>
          <div class="display-6">{{ callbacks_count }}</div>
          <a href="{{ url_for('export_callbacks_csv') }}" class="btn btn-sm btn-outline-secondary mt-2">Export CSV</a>
        </div>
      </div>
    </div>
  </div>
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="text-muted text-uppercase">NDA Requests</h6>
          <div class="display-6">{{ nDAs_count }}</div>
          <a href="{{ url_for('export_NDA_csv') }}" class="btn btn-sm btn-outline-secondary mt-2">Export CSV</a>
        </div>
      </div>
    </div>


  <!-- Recent Users -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4 class="card-title mb-0">Recent Users</h4>
      </div>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>ID</th><th>Email</th><th>Role</th><th>Name</th><th>Company</th><th>Phone</th>
            </tr>
          </thead>
          <tbody>
            {% for u in recent_users %}
            <tr>
              <td>{{ u.id }}</td>
              <td>{{ u.email }}</td>
              <td>{{ u.role }}</td>
              <td>{{ (u.first_name or '') ~ ' ' ~ (u.surname or '') }}</td>
              <td>{{ u.company_name or '' }}</td>
              <td>{{ u.phone or '' }}</td>
            </tr>
            {% else %}
            <tr><td colspan="6" class="text-muted">No users.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Recent Projects -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4 class="card-title mb-0">Recent Projects</h4>
      </div>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>ID</th><th>Title</th><th>Type</th><th>Location</th>
              <th>Budget</th><th>Funding</th><th>IRR</th><th>Owner</th><th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for p in recent_projects %}
            <tr>
              <td>{{ p.id }}</td>
              <td>{{ p.title }}</td>
              <td>{{ p.project_type }}</td>
              <td>{{ p.location }}</td>
              <td>{{ "%.2f"|format(p.budget) if p.budget is not none }}</td>
              <td>{{ "%.2f"|format(p.funding) if p.funding is not none }}</td>
              <td>{{ "%.1f"|format(p.irr) if p.irr is not none }}</td>
              <td>{{ p.user_id }}</td>
              <td>
                <a class="btn btn-sm btn-outline-primary" href="{{ url_for('project_detail', project_id=p.id) }}">View</a>
                {% if current_user.is_authenticated and (current_user.role == 'admin' or current_user.id == p.user_id) %}
                  <a class="btn btn-sm btn-outline-warning" href="{{ url_for('edit_project', project_id=p.id) }}">Edit</a>
                {% endif %}
              </td>
            </tr>
            {% else %}
            <tr><td colspan="9" class="text-muted">No projects.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Recent Callback Requests -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4 class="card-title mb-0">Recent Callback Requests</h4>
      </div>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>ID</th><th>Name</th><th>Company</th><th>Email</th><th>Phone</th><th>Message</th><th>Time</th>
            </tr>
          </thead>
          <tbody>
            {% for c in recent_callbacks %}
            <tr>
              <td>{{ c.id }}</td>
              <td>{{ c.name }}</td>
              <td>{{ c.company or '' }}</td>
              <td>{{ c.email or '' }}</td>
              <td>{{ c.phone }}</td>
              <td>{{ (c.message or '')[:80] }}</td>
              <td>{{ c.timestamp }}</td>
            </tr>
            {% else %}
            <tr><td colspan="7" class="text-muted">No callback requests.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
    <!-- Recent NDA Requests -->
    <div class="card mb-4 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h4 class="card-title mb-0">Recent NDA Requests</h4>
        </div>
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>ID</th><th>Name</th><th>Company</th><th>Email</th><th>Phone</th><th>Message</th><th>Time</th>
              </tr>
            </thead>
            <tbody>
              {% for c in recent_NDA_Requests %}
              <tr>
                <td>{{ c.id }}</td>
                <td>{{ c.name }}</td>
                <td>{{ c.company or '' }}</td>
                <td>{{ c.email or '' }}</td>
                <td>{{ c.phone }}</td>
                <td>{{ (c.message or '')[:80] }}</td>
                <td>{{ c.timestamp }}</td>
              </tr>
              {% else %}
              <tr><td colspan="7" class="text-muted">No NDA requests.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>


  <div class="text-center">
    <a href="{{ url_for('home') }}" class="btn btn-outline-secondary">Back to Home</a>
  </div>
</div>
{% endblock %}

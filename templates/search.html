{% extends "base.html" %}
{% block title %}Search — RE Marketplace{% endblock %}
{% block content %}

{% block styles %}
<style>
  .muted-inputs .form-control,
  .muted-inputs .form-select {
    background-color: #f5f5f5;
    border: 1px solid #ccc;
    color: #333;
  }
  .muted-inputs .form-control:focus,
  .muted-inputs .form-select:focus {
    background-color: #ffffff;
    border-color: #777;
    box-shadow: none;
  }
</style>
{% endblock %}

<div class="card">
  <div class="card-body">
    <h2 class="card-title">Search Projects</h2>

    <form method="POST" class="mb-3">
      {{ form.hidden_tag() }}

      <div class="row g-3 align-items-stretch">
        <!-- Keyword -->
        <div class="col-12 col-md-6 col-lg-3">
          <div class="filter-box h-100">
            <label class="form-label mb-1" for="query">Keyword</label>
            {{ form.query(class="form-control", id="query", placeholder="Title, description…") }}
          </div>
        </div>

        <!-- Country (multi) -->
        <div class="col-12 col-md-6 col-lg-3">
          <div class="filter-box h-100">
            <label class="form-label mb-1" for="countries">Country (Ctrl/Cmd for multiple)</label>
            {{ form.countries(class="form-select", id="countries", multiple=True) }}
            <!-- <div class="form-text">Hold Ctrl/Cmd to select multiple.</div> -->
          </div>
        </div>


        <!-- Location type -->
        <div class="col-12 col-md-6 col-lg-3">
          <div class="filter-box h-100">
            <label class="form-label mb-1" for="location_type">Location Type</label>
            {{ form.location_type(class="form-select", id="location_type") }}
          </div>
        </div>

        <!-- Min IRR -->
        <div class="col-12 col-md-6 col-lg-3">
          <div class="filter-box h-100">
            <label class="form-label mb-1" for="irr">Min. IRR (%)</label>
            {{ form.irr(class="form-control", id="irr", placeholder="e.g. 12") }}
          </div>
        </div>
        
        <!-- Search on the right -->
        <div class="col-12 d-flex justify-content-end">
          {{ form.submit(class="btn btn-success") }}
        </div>
      </div>
    </form>

    <h3>Results ({{ projects|length }} found):</h3>

    {% if projects %}
      <div class="list-group">
        {% for project in projects %}
          <div class="list-group-item">
            <h5 class="mb-1">{{ project.title }}</h5>
            <p class="mb-1">Type: {{ project.project_type }} | Risk: {{ project.risk_level }}/10</p>
            <p class="mb-1">
              Budget: ${{ "%.2f"|format(project.budget) }}M |
              Funding: ${{ "%.2f"|format(project.funding) }}M |
              IRR: {{ "%.1f"|format(project.irr) }}% |
              Duration: {{ project.duration }} months
            </p>
            <p class="mb-1">Location: {{ project.location }}</p>
            <p class="mb-2">Synopsis: {{ project.description[:200] }}...</p>

            <a class="btn btn-sm btn-outline-primary"
               href="{{ url_for('project_detail', project_id=project.id) }}">View</a>

            {% if project.attachment_path %}
              <a href="{{ url_for('uploaded_file', filename=project.attachment_path) }}"
                 class="btn btn-sm btn-outline-secondary" target="_blank">Attachment</a>
            {% endif %}

            {% if current_user.is_authenticated and current_user.role == 'investor' %}
              <a href="{{ url_for('nda_request', project_id=project.id) }}"
                 class="btn btn-sm btn-success">Request NDA</a>
            {% endif %}

            {% if current_user.is_authenticated and (current_user.role == 'admin' or current_user.id == project.user_id) %}
              <a href="{{ url_for('edit_project', project_id=project.id) }}"
                 class="btn btn-sm btn-outline-warning">Edit</a>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted">No projects found.</p>
    {% endif %}
  </div>
</div>

<!-- Optional: re-init Select2 if needed -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    if (window.jQuery && $('#countries').length && $('#countries').select2) {
      $('#countries').select2({ placeholder: "Select countries", width: '100%' });
    }
  });
</script>
{% endblock %}

{% extends "base.html" %}

{% block content %}
<div class="card">
  <div class="card-body">
    <h2 class="card-title">Search Projects</h2>

    <!-- Search form -->
    <form method="POST" class="row g-3 align-items-end mb-4">
      {{ form.hidden_tag() }}

      <!-- Query -->
      <div class="col-md-5">
        <label class="form-label" for="query">Search</label>
        {{ form.query(class="form-control", id="query", placeholder="Title, description, or location", value=query) }}
      </div>

      <!-- Countries (multi-select) -->
      <div class="col-md-5">
        <label class="form-label" for="countries">Countries</label>
        {{ form.countries(class="form-select", id="countries", multiple=True) }}
        <div class="form-text">Hold Ctrl/Cmd to select multiple.</div>
      </div>

      <!-- Submit -->
      <div class="col-md-2 d-grid">
        {{ form.submit(class="btn btn-outline-secondary") }}
      </div>
    </form>

    <!-- Results -->
    <h3>Results ({{ projects|length }} found):</h3>

    {% if projects %}
      <div class="list-group">
        {% for project in projects %}
          <div class="list-group-item">
            <h5 class="mb-1">{{ project.title }}</h5>

            <p class="mb-1">
              Type: {{ project.project_type }} |
              Risk: {{ project.risk_level }}/10
            </p>

            <p class="mb-1">
              Budget: ${{ "%.2f"|format(project.budget) }}M |
              Funding: ${{ "%.2f"|format(project.funding) }}M |
              IRR: {{ "%.1f"|format(project.irr) }}% |
              Duration: {{ project.duration }} months
            </p>

            <p class="mb-1">Location: {{ project.location }}</p>
            <p class="mb-2">Synopsis: {{ project.description[:200] }}{% if project.description|length > 200 %}...{% endif %}</p>

            <!-- Action buttons -->
            <div class="mt-2 d-flex flex-wrap gap-2">

              <!-- View (all authenticated users) -->
              <a class="btn btn-sm btn-outline-primary"
                 href="{{ url_for('project_detail', project_id=project.id) }}">
                 View
              </a>

              <!-- Attachment (if any) -->
              {% if project.attachment_path %}
                <a class="btn btn-sm btn-outline-secondary"
                   href="{{ url_for('uploaded_file', filename=project.attachment_path) }}"
                   target="_blank"
                   title="Open attached document">
                   Attachment
                </a>
              {% endif %}

              <!-- Edit (owner or admin) -->
              {% if current_user.is_authenticated and (current_user.role == 'admin' or current_user.id == project.user_id) %}
                <a class="btn btn-sm btn-outline-warning"
                   href="{{ url_for('edit_project', project_id=project.id) }}">
                   Edit
                </a>
              {% endif %}

              <!-- Request Callback (available to everyone) -->
              <a class="btn btn-sm btn-outline-secondary"
                 href="{{ url_for('request_callback') }}"
                 title="Have our team call you to discuss this project">
                 Request Callback
              </a>

              <!-- Request NDA (investors only) -->
              {% if current_user.is_authenticated and current_user.role == 'investor' %}
                <a class="btn btn-sm btn-primary"
                   href="{{ url_for('nda_request', project_id=project.id) }}"
                   title="Request a tri-party NDA to access confidential materials">
                   Request NDA
                </a>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted">No projects found.</p>
    {% endif %}
  </div>
</div>
{% endblock %}
